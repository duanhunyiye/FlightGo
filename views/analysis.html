<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="author" content="FlightGo:小叶 傻彪 老杨">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>FlightGo-数据聚合</title>

    <!-- Bootstrap -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="/static/css/filter.css">
    
    <!-- 引入 echarts.js -->
    <script src="/static/js/echarts.min.js"></script>
    <script src="/static/js/world.js"></script>
    <script type="text/javascript" src="/static/js/airportGPS.js"></script>
    <script type="text/javascript" src="/static/js/airlines.js"></script>
    <script type="text/javascript" src="/static/js/country.js"></script>
    <style type="text/css">
       
        
        
        
        .body{
          margin:-19px 100px 100px 100px;
        }
        
        
        #data-none .panel-info{
          margin-top: 60px;
        }

        .container-fluid{
          background-color: #337ab7;

        }
        .container-fluid a{
          color:#dff0d8;
          
        }
        .search{
          height: 35px;
          width: 170px;
          margin-right:70px;
          
        }
        

        .form-group{
          
          margin-left:0px;
          margin-right:20px;
        }

        .more-btn{
          width: 160px;
          margin-left: auto;
          margin-right: auto;
          
        }

        .plane_img{
          height: 200px;
          display: block;
          margin:auto;  
        }

        /*切换类型搜索*/
        /*切换类型*/
        #btn-sw-search-type{
            height: 35px;
            width: 182px;
            background-color: #FFFFFF;
            border:1px solid #C2C2C2;
            border-radius:8px;

        }
        .btn-lg{
            padding: 6px 15px;
            font-size: 14px;
        }
        .action {

            color: #FFFFFF !important;/*提高优选级*/
            background-color: #3D86E5;
        }
        
        .form-group a{
            color: #9e9e9e;
        }
        

        #subtitle{
          padding-left: 20px;
          font-size: 15px;
          color: #9a9a9a;
        }

         /*提示框宽度*/
        .typeahead{
            width: 200px;

        }

        #tip{
            position:absolute;
            top:52px;
            display: none;
            z-index: 999;
        }

        .class-change{
          padding-top: 30px;

        }
        
        #map {
          height: 100%;
        }
        #data-img {
          height: 800px;
        }
        #choose{
          height: 800px;
        }
        .form-control{
          width: 70%;

        }
        
        .input-group{
          width: 70%;
          margin: 0 auto;
        }

        .dropdown{
          font-size: 16px;
          width: 70%;
        }
        .search-btn{
          width: 60%;
          float:right;
        }
        .type-btn{
          width: 130px;
        }
        .switch_in_out{
          
          
          border:1px solid #C2C2C2;
          border-radius:6px;
          position: absolute;
          z-index: 999;
          right: 20px;
          top: 100px;

        }
        #out{
          float: left;
        }

        .searching{
          
          cursor:not-allowed;

        }

        #yqf{
          position: absolute;
          
        }

        #o-input{
          float: left;
          width: 45%;
        }
        #d-input{
          position: relative;
          left: 30px;
          width: 45%;

        }

        #text_p{
          position: absolute;
          display: none;
          left: -35px;
          top: 8px;
        }
        .tip{
          font-size: 20px;
          margin-top: 30px;
          color: #9b9c9b;
        }
        
        .nav > li > a:focus, .nav > li > a:hover {
            text-decoration: none;
            background-color: #337ab7;
        }

        .pager li a {
          cursor:default;
        }



        
    </style>  
  </head>

  <body>


    <nav class="navbar ">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">FlightGo</a>
        </div>
        <ul class="nav navbar-nav">

            <li ><a href="/">首页</a></li>
            <li><a href="/analysis/">数据聚合分析</a></li>

          </ul>
      </div>
    </nav>

    <div class="body">
        <!-- 类型选择 -->
        <div class="class-change">
          <div class="form-group">
          <div class="col-xs-3">
              <div class="dropdown input-group">
                
                <button type="button" class="btn btn-default dropdown-toggle type-btn" id="dropdownMenu1" data-toggle="dropdown">聚合类型: 机场
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                    <li role="presentation" name="type-li">
                        <a role="menuitem" tabindex="-1">国家</a>
                    </li>
                    <!--
                    <li role="presentation" name="type-li">
                        <a role="menuitem" tabindex="-1">起降</a>
                    </li>
                    -->
                    <li role="presentation" name="type-li">
                        <a role="menuitem" tabindex="-1">航司</a>
                    </li>
                </ul>
              </div>
          </div>
          <div class="col-xs-3">
             <input type="text" data-provide="typeahead" data-items="4" class="form-control" id="airport-input" value="北京首都" placeholder="请输入机场名称" autocomplete="off">

             <input type="hidden" data-provide="typeahead" data-items="4" class="form-control" value="中国" id="country-input" placeholder="请输入国家" autocomplete="off">

             <input type="hidden" data-provide="typeahead" data-items="4" class="form-control" id="airline-input" placeholder="请输入航空公司" autocomplete="off">
             <div id="od-div" style="display: none;">

                <input data-provide="typeahead" data-items="4" class="form-control" id="o-input" placeholder="起飞地" autocomplete="off">
                    <img id="yqf" src="/static/img/yqf.png" width="30px"/>
                  
                 <input data-provide="typeahead" data-items="4" class="form-control" id="d-input" placeholder="降落地" autocomplete="off">
             </div>

          </div>  
          <div class="col-xs-3">
              <!-- 日历 -->
             <div class="input-group date form_date" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
                    <input class="form-control data-input" size="12" type="text" value="2018-05-15" readonly>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                </div>
                <input type="hidden" id="dtp_input2" name="date" value="2018-05-15" />
          </div> 
          <div class="col-xs-3">
             <button id="start_search" type="button" class="btn btn-success search-btn">开始查询</button>
          </div>

        </div><!--form-group-->

        </div>
        <!-- 数据图表 -->
        <div id="data-img">
            <div id="map" class="col-xs-7"></div>
            <div class="col-xs-5">
              
              <div id="out-in" class="switch_in_out" style="display: none;">
                  <p id="text_p" >跨境</p>
                  <a id="out" class="btn btn-lg action">出港</a>
                  <a id="in" class="btn btn-lg">进港</a>
                  <input id="search-type" type="hidden" name="show-type" value="0">
              </div>  
               <div id="choose">
                  
              </div> 
            </div>
        </div>
        <hr>
        <div id="data-none" style="display: none;">
            <div class="panel panel-info">
          <div class="panel-heading">航班历史信息</div>
          <div class="panel-body">
            <div class="row">
              <img class="plane_img" src="/static/img/plane_none.png">
            </div>
            <div class="row">
              <p class="text-center tip">抱歉，没有找到您输入的相关航班信息</p>
            </div>
          </div>
          </div>
      </div>
      <div id="data-list" class="panel panel-info" style="display: none;">
        
          <div class="panel-heading">数据详情</div>
          <div class="panel-body">
            <table id="data-table" class="table table-striped table-CA">
              <tr>
                <th>航班号</th>
                <th>出发地</th>
                <th>目的地</th>
                <th>状态</th>
              </tr>
            </table>
           
              <ul class="pager">
                <li id="previous"><a class="disabled">上一页</a></li>
                <li id="next"><a>下一页</a></li>
              </ul>
            

          </div>
    </div>
          
      </div>


  </div>
    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="/static/js/jquery-3.3.1.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap3-typeahead.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap-datetimepicker.js" charset="UTF-8"></script>
    <script type="text/javascript" src="/static/js/locales/bootstrap-datetimepicker.fr.js" charset="UTF-8"></script>

    <script type="text/javascript">
      //echars 
      var map = echarts.init(document.getElementById('map'));

      var choose = echarts.init(document.getElementById('choose'));

      var data_img = document.getElementById("data-img");
      var data_none = document.getElementById("data-none");
      var out_in = document.getElementById("out-in");
      var off_on = document.getElementById("text_p");
      var data_list = document.getElementById("data-list");
      //搜索类型
      var s_ty = 0;

      //进出港的数据
      var out_datas = [];
      var in_datas = [];
      var c_out_datas = [];
      var c_in_datas = [];

      
      var temp = [];
      var end_page = false;
      var page_num = 1;//页码

      

      //on 跨境
      var on_b_m_datas = [];
      var off_b_m_datas = [];
      var on_b_c_datas = [];
      var off_b_c_datas = [];

      //数据详情
      var left_data_info = [];
      var right_data_info = [];


      //监听上下页
      $("#previous").click(function(){
        
        if(page_num > 1){
          page_num = page_num - 1;
          insert(page_num,temp);
        }
        
      });

      $("#next").click(function(){
        
        if(!end_page){
          page_num = page_num + 1;
          insert(page_num,temp);
        }
        
      
        
      });



      var map_option = {
          tooltip:{
                trigger:'item'
          },
          geo: {
            map: 'world',
            roam: true,
            zoom: 1.4,
            silent:true
          },
          legend: {
            show:false,
            orient: 'vertical',
            x:'right',
            data:['准点','取消','延误','未上报'],
            textStyle: {
                color: '#fff'
            }
            
          },

          series:[]
      }
      

      var choose_option = {
          
          title:{
            text:"\n\n机场聚合",
            subtext:"北京首都共0条航班",
            x:"center"
          },
          legend:{
              //图例标记和文本的对齐。
              orient:'vertical',
              x:'right',
              y:'center',
              itemHeight:20,
              itemWidth:30,
              data:['准点','取消','延误','未上报']
          },

          tooltip : {
              trigger: 'item',
              formatter: "{c} ({d}%)"
          },
    
          series:[
            {
              type: 'pie',
              radius : '55%',
              center: ['40%', '50%'],
              itemStyle: {
                emphasis: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              },
              data: [],
              

            }
          ]

      }
      
      var mydiv_resize=function(){

          var opt = {
              width:'auto',
              height:'auto'
          };
          map.resize(opt);
          choose.resize(opt);

      }
      window.onresize=mydiv_resize

      $('.form_date').datetimepicker({
            language:  'en',
            weekStart: 1,
            todayBtn:  1,
            autoclose: 1,
            todayHighlight: 1,
            startView: 2,
            minView: 2,
            forceParse: 0
      });



      //处理机场聚合显示数据
      var show_datas_func = function(){
          
         
          var airport_name = $("#airport-input").val();
          var date = $("#dtp_input2").val().split('-');
          if(airport_name == ""){
              alert("请正确输入查询项");
              return
          }
          url = "/api/airports/"+airport_name+"/"+date[0]+"/"+date[1]+"/"+date[2]+"/flights/";
          $("#start_search").addClass("searching");
          $("#start_search").text("查询中...");
          $.getJSON(url,function(json_datas){
              json_datas = json_datas['data'];
          out_datas = [];
          in_datas = [];
          c_out_datas = [];
          c_in_datas = [];
          left_data_info = [];
          right_datta_info = [];

          var out_ = json_datas['out']
          var in_ = json_datas['in']
          
          if(json_datas['code'] != 0){
            //出港
            for(k in out_){

              out_[k] = remove_null(out_[k])
              
              if(out_[k].length > 0){

                  var m_out_option = {  

                        name:k,
                        type: 'lines',
                        coordinateSystem: 'geo',
                        lineStyle: {
                            normal: {
                                color:get_color(k),
                                opacity: 0.4,
                                width: 1.1,

                                curveness: 0.3
                            }
                        },
                        data:out_[k].map(function(item){
                            var t_k = Object.keys(item)[0];
                            if(geoCoordMap[t_k] && geoCoordMap[json_datas['airport']]){

                                left_data_info.push({

                                  'ident':item[t_k],
                                  'origin':geoCoordMap[json_datas['airport']][2],
                                  'destination':geoCoordMap[t_k][2],
                                  'state':k
                                });
                                return {
                                   name:geoCoordMap[json_datas['airport']][2]+' - '+geoCoordMap[t_k][2]+'<br>'+"航班号："+item[t_k],
                                   coords:[[
                                    geoCoordMap[json_datas['airport']][0],
                                    geoCoordMap[json_datas['airport']][1]
                                    ],
                                    [
                                    geoCoordMap[t_k][0],
                                    geoCoordMap[t_k][1]]]
                              
                                }
                            }else{
                              return;
                            }
                            
                            
                        })
                  }

                  var c_out_option = {
                    value:out_[k].length,
                    name:k,
                    itemStyle:{
                        color:get_color(k),
                    }
                  }
                  
                  
                  out_datas.push(m_out_option);
                  c_out_datas.push(c_out_option);
                }
            }

            //进港
            for(k in in_){
              in_[k] = remove_null(in_[k])
              if(in_[k].length > 0){
                  var m_in_option = {  

                        name:k,
                        type: 'lines',
                        coordinateSystem: 'geo',
                        lineStyle: {
                            normal: {
                                color:get_color(k),
                                opacity: 0.4,
                                width: 1.1,

                                curveness: 0.3
                            }
                        },
                        data:in_[k].map(function(item){
                            var t_k = Object.keys(item)[0];
                            right_data_info.push({

                                  'ident':item[t_k],
                                  'origin':geoCoordMap[t_k][2],
                                  'destination':geoCoordMap[json_datas['airport']][2],
                                  'state':k
                            });
                            return {
                                 name:geoCoordMap[t_k][2]+' - '+geoCoordMap[json_datas['airport']][2]+'<br>'+"航班号："+item[t_k],
                                 coords:[[geoCoordMap[t_k][0],
                                  geoCoordMap[t_k][1]],
                                  [
                                  geoCoordMap[json_datas['airport']][0],
                                  geoCoordMap[json_datas['airport']][1]]]
                              
                            }
                            
                        })
                  }

                  var c_in_option = {
                    value:in_[k].length,
                    name:k,
                    itemStyle:{
                        color:get_color(k),
                    }
                  }
                  
                  
                  in_datas.push(m_in_option);
                  c_in_datas.push(c_in_option);
                }
            }
            $("#out").text("出港");
            $("#in").text("进港");
            data_img.style.display = "block";
            out_in.style.display = "block";
            data_list.style.display = "block";
            data_none.style.display = "none";
            off_on.style.display = "none";
            out_in.style.width = "122px";
            map_option['series'] = out_datas;
            choose_option['series'][0]['data'] = c_out_datas;

            choose.clear();
            map.clear();
            choose_option['title']['text'] = "\n\n机场聚合"; 
            
            choose_option['title']['subtext'] = geoCoordMap[json_datas['airport']][2]+
              " 共 " + count_element(out_datas).toString()+ " 条航班";
            
            choose.setOption(choose_option);
            map.setOption(map_option);
            echarts.connect([map,choose]);
            temp = left_data_info;
            page_num = 1;
            insert(1,left_data_info);

          }else{
            data_img.style.display = "none";
            out_in.style.display = "none";
            data_none.style.display = "block"
            data_list.style.display = "none";
          }

          $("#start_search").removeClass("searching");
          $("#start_search").text("开始查询");

          $("#out").addClass("action");
          $("#in").removeClass("action");
      })
      }

      //数据插入表格
      var insert = function(index,datas){
          var date = $("#dtp_input2").val().split("-");

          var year = date[0];
          var month = date[1];
          var day = date[2];
          var temp = 0;

          var start = (index-1)*40;//开始
          var end = index*40;//结束

          var count = 0; //显示了多少
          
          $("#data-table tr:not(:first)").html("");  //清空表格，不清空表头
          if(datas.length > end && start <= datas.length){
            
            for(var i=start;i<end;i++){
              
              var html_text = '<tr><td><a href="/flight/'+
                datas[i]["ident"]+'/'+year+'/'+month+'/'+day+'/">'+datas[i]["ident"]+'</a></td><td>'+datas[i]["origin"]+'</td><td>'+
                datas[i]['destination']+'</td><td>'+datas[i]['state']+'</td></tr>';


              $("#data-table").append(html_text);

            }
            $("#next").removeClass("disabled")
            if(datas[end+1]){
              end_page = false;
            }else{
              end_page = true;
            }
            

          }else if(start <= datas.length && datas.length <= end){
            
            for(var i=start;i<datas.length;i++){

              var html_text = '<tr><td><a href="/flight/'+
                datas[i]["ident"]+'/'+year+'/'+month+'/'+day+'/">'+datas[i]["ident"]+'</a></td><td>'+datas[i]["origin"]+'</td><td>'+
                datas[i]['destination']+'</td><td>'+datas[i]['state']+'</td></tr>';

              $("#data-table").append(html_text);

            }
            //最后一页
            $("#next").addClass("disabled")
            end_page = true;
          }

          if(start == 0){
            //第一页
            $("#previous").addClass("disabled");
            

          }else{
            $("#previous").removeClass("disabled");
            
          }
          

      }
      
      
      show_datas_func();
      

      //处理航司聚合数据
      function c_airline_data(){
          var airline = $("#airline-input").val();
          var date = $("#dtp_input2").val().split('-');
          if(airline == ""){
              alert("请正确输入查询项");
              return
          }
          url = "/api/airlines/"+airline+"/"+date[0]+"/"+date[1]+"/"+date[2]+"/flights";
          $("#start_search").addClass("searching");
          $("#start_search").text("查询中...");

          $.getJSON(url,function(datas){
              datas = datas["data"]
              if(datas['code'] != 0){

                var map_datas = []
                var cho_datas = []
                var res = datas["result"]
                left_data_info = [];
                right_datta_info = [];
                //数据处理
                Object.keys(res).forEach(function(k){
                  if(res[k].length > 0 ){
                  var state = k;
                  var m_option = {

                    name:k,
                    type: 'lines',
                    coordinateSystem: 'geo',
                    lineStyle: {
                        normal: {
                            color:get_color(k),
                            opacity: 0.4,
                            width: 1.1,

                            curveness: 0.3
                        }
                    },
                    data:function(item){
                      var temp = [];
                      
                      for(var i=0;i<item.length;i++){

                        var k = Object.keys(item[i])[0]

                        if(geoCoordMap[item[i][k][0]] && geoCoordMap[item[i][k][1]]){

                          var option = {

                              name:geoCoordMap[item[i][k][0]][2]+' - '+geoCoordMap[item[i][k][1]][2]+'<br>'+"航班号："+k,
                              coords:[[geoCoordMap[item[i][k][0]][0],

                              geoCoordMap[item[i][k][0]][1]],
                              [
                              geoCoordMap[item[i][k][1]][0],
                              geoCoordMap[item[i][k][1]][1]]]
                          }
                          left_data_info.push({

                                  'ident':k,
                                  'origin':geoCoordMap[item[i][k][0]][2],
                                  'destination':geoCoordMap[item[i][k][1]][2],
                                  'state':state
                          });
                          temp.push(option);
                        }
                        
                      }
                      
                      return temp;
                      }(res[k])
                    }

                  
                    var c_option = {
                      //这忽略null和不存在geoCoordMap的机场
                      value:res[k].length,
                      name:k,
                      itemStyle:{
                          color:get_color(k),
                      }
                    }
                    cho_datas.push(c_option);
                    map_datas.push(m_option);
                  }
                  
                  
                });
                

                //显示数据
                data_img.style.display = "block";
                out_in.style.display = "none";
                data_list.style.display = "block";
                data_none.style.display = "none"
                
                map_option['series'] = map_datas;
                choose_option['series'][0]['data'] = cho_datas;

                
                choose.clear();
                map.clear();
                choose_option['title']['text'] = "\n\n航司聚合"; 
                
                choose_option['title']['subtext'] = datas['airline']+
                  " 共 " + datas['count'] + " 条航班";
                
                choose.setOption(choose_option);
                map.setOption(map_option);
                echarts.connect([map,choose]);
                temp = left_data_info;
                page_num = 1;
                insert(1,left_data_info);

              }else{
                data_img.style.display = "none";
                out_in.style.display = "none";
                data_list.style.display = "none";
                data_none.style.display = "block"
              }

              $("#start_search").removeClass("searching");
              $("#start_search").text("开始查询");

              $("#out").addClass("action");
              $("#in").removeClass("action");
          })
      }

      //处理国家聚合数据
      function c_country_data(){
          var country = $("#country-input").val();
          
          var date = $("#dtp_input2").val().split('-');
          if(country == ""){
              alert("请正确输入查询项");
              return
          }
          url = "/api/country/"+countryNames[country]+"/"+date[0]+"/"+date[1]+"/"+date[2]+"/flights/";


          $("#start_search").addClass("searching");
          $("#start_search").text("查询中...");
          $.getJSON(url,function(datas){
              datas = datas["data"]
              var m_n_c_b_datas = []; //不包含跨境的地图数据
              var c_n_c_b_datas = []; //不包含跨境的饼图数据

              var m_default_datas = []; //包含跨境的地图数据
              var c_default_datas = []; //包含跨境的饼图数据

              left_data_info = [];
              right_data_info = [];
              
              if(datas['code'] != 0){

                var not_c_b = datas["not_c_b"]; //不跨境数据
                var default_ = datas["default"]; //跨境数据
                //数据处理
                //不包含跨境
                Object.keys(not_c_b).forEach(function(k){
                    if(not_c_b[k].length > 0){
                      var state = k;
                      var m_option = {
                          name:k,
                          type: 'lines',
                          coordinateSystem: 'geo',
                          lineStyle: {
                              normal: {
                                  color:get_color(k),
                                  opacity: 0.4,
                                  width: 1.1,

                                  curveness: 0.3
                              }
                          },
                          data:function(item){
                            var temp = [];
                            
                            for(var i=0;i<item.length;i++){

                              var k = Object.keys(item[i])[0]

                              if(geoCoordMap[item[i][k][0]] && geoCoordMap[item[i][k][1]]){

                                var option = {

                                    name:geoCoordMap[item[i][k][0]][2]+' - '+geoCoordMap[item[i][k][1]][2]+'<br>'+"航班号："+k,
                                    coords:[[geoCoordMap[item[i][k][0]][0],

                                    geoCoordMap[item[i][k][0]][1]],
                                    [
                                    geoCoordMap[item[i][k][1]][0],
                                    geoCoordMap[item[i][k][1]][1]]]
                                }
                                
                                temp.push(option);
                              }
                              
                            }
                      
                            return temp;
                            }(not_c_b[k])
                        }

                  
                        var c_option = {
                          //这忽略null和不存在geoCoordMap的机场
                          value:not_c_b[k].length,
                          name:k,
                          itemStyle:{
                              color:get_color(k),
                          }
                        }
                        m_n_c_b_datas.push(m_option);
                        c_n_c_b_datas.push(c_option);

                    }
                });

                Object.keys(default_).forEach(function(k){
                    if(default_[k].length > 0){
                      var state = k;
                      var m_option = {
                          name:k,
                          type: 'lines',
                          coordinateSystem: 'geo',
                          lineStyle: {
                              normal: {
                                  color:get_color(k),
                                  opacity: 0.4,
                                  width: 1.1,

                                  curveness: 0.3
                              }
                          },
                          data:function(item){
                            var temp = [];
                            
                            for(var i=0;i<item.length;i++){

                              var k = Object.keys(item[i])[0]

                              if(geoCoordMap[item[i][k][0]] && geoCoordMap[item[i][k][1]]){

                                var option = {

                                    name:geoCoordMap[item[i][k][0]][2]+' - '+geoCoordMap[item[i][k][1]][2]+'<br>'+"航班号："+k,
                                    coords:[[geoCoordMap[item[i][k][0]][0],

                                    geoCoordMap[item[i][k][0]][1]],
                                    [
                                    geoCoordMap[item[i][k][1]][0],
                                    geoCoordMap[item[i][k][1]][1]]]
                                }
                                
                                temp.push(option);
                              }
                              
                            }
                      
                            return temp;
                            }(default_[k])
                        }

                  
                        var c_option = {
                          //这忽略null和不存在geoCoordMap的机场
                          value:default_[k].length,
                          name:k,
                          itemStyle:{
                              color:get_color(k),
                          }
                        }
                        m_default_datas.push(m_option);
                        c_default_datas.push(c_option);

                    }
                });

                off_b_m_datas = m_n_c_b_datas;
                on_b_m_datas = merge_map_datas(m_default_datas,m_n_c_b_datas);

                off_b_c_datas = c_n_c_b_datas;
                on_b_c_datas = merge_pie_datas(c_default_datas,c_n_c_b_datas);

                //显示数据
                data_img.style.display = "block";
                data_list.style.display = "none";
                out_in.style.display = "block";
                data_none.style.display = "none"
                off_on.style.display = "block";
                out_in.style.width="116px"
                $("#out").text("ON");
                $("#in").text("OFF");
                map_option['series'] = on_b_m_datas;
                choose_option['series'][0]['data'] = on_b_c_datas;

                choose.clear();
                map.clear();
                choose_option['title']['text'] = "\n\n国家聚合"; 
                
                var count  = count_flight(choose_option['series'][0]['data']);
                choose_option['title']['subtext'] = " 共 " + count+ " 条航班";
                
                choose.setOption(choose_option);
                map.setOption(map_option);
                echarts.connect([map,choose]);
                

              }else{
                data_img.style.display = "none";
                out_in.style.display = "none";
                data_list.style.display = "none";
                data_none.style.display = "block"
              }

              $("#start_search").removeClass("searching");
              $("#start_search").text("开始查询");

              $("#out").addClass("action");
              $("#in").removeClass("action");
          });
      }

      //处理起降点聚合数据
      function c_od_data(){
          var o = $("#o-input").val();
          var d = $("#d-input").val();
          var date = $("#dtp_input2").val().split('-');
          if(o == "" || d == ""){
              alert("请正确输入查询项");
              return
          }
          url = "/api/get/agg/od/"+o+"/"+d+"/"+date[0]+"/"+date[1]+"/"+date[2]+"/";
          $("#start_search").addClass("searching");
          $("#start_search").text("查询中...");
          $.getJSON(url,function(datas){
            if(datas['code'] != 0){

                var map_datas = []
                var cho_datas = []
                var res = datas["result"]
                var opacity = 0.4
                //数据处理
                Object.keys(res).forEach(function(k){
                  opacity += 1.5
                  var m_option = {

                    name:k,
                    type: 'lines',
                    coordinateSystem: 'geo',
                    lineStyle: {
                        normal: {
                            color:get_color(k),
                            opacity: opacity,
                            width: 1.2,
                            curveness: 0.4
                        }
                    },
                    data:function(item){
                      var temp = [];
                      
                      for(var i=0;i<item.length;i++){

                        var k = Object.keys(item[i])[0]

                        if(geoCoordMap[item[i][k][0]] && geoCoordMap[item[i][k][1]]){

                          var option = {

                              name:geoCoordMap[item[i][k][0]][2]+' - '+geoCoordMap[item[i][k][1]][2]+'<br>'+"航班号："+k,
                              coords:[[geoCoordMap[item[i][k][0]][0],

                              geoCoordMap[item[i][k][0]][1]],
                              [
                              geoCoordMap[item[i][k][1]][0],
                              geoCoordMap[item[i][k][1]][1]]]
                          }

                          temp.push(option);
                        }
                        
                      }
                      
                      return temp;
                    }(res[k])
                  }

                  if(res[k].length > 0 ){
                      var c_option = {
                        //这忽略null和不存在geoCoordMap的机场
                        value:res[k].length,
                        name:k,
                        itemStyle:{
                            color:get_color(k),
                        }
                      }
                      cho_datas.push(c_option);
                  }
                  map_datas.push(m_option);

                });
                

                //显示数据
                data_img.style.display = "block";
                out_in.style.display = "none";
                data_none.style.display = "none"
                
                map_option['series'] = map_datas;
                choose_option['series'][0]['data'] = cho_datas;

                

                choose.clear();
                map.clear();
                choose_option['text'] = "\n\n起降点聚合"; 
                
                choose_option['title']['subtext'] = datas['origin']+" - "+datas["destination"]+
                  " 共 " + datas['count'] + " 条航班";
                
                choose.setOption(choose_option);
                map.setOption(map_option);
                echarts.connect([map,choose]);

              }else{
                data_img.style.display = "none";
                out_in.style.display = "none";
                data_none.style.display = "block"
              }

              $("#start_search").removeClass("searching");
              $("#start_search").text("开始查询");

              $("#out").addClass("action");
              $("#in").removeClass("action");
          });

      }
      //查询
      $("#start_search").click(function(){

          switch(s_ty){
            case 0:
              show_datas_func();
              break;
            case 1:
              c_country_data();
              break;
            case 2:
              c_od_data();
              break;
            case 3:
              c_airline_data()
              break;
          }
          
      });


      //进出港切换
      $("#in").click(function(){

          $("#out").removeClass("action");
          $(this).addClass("action");
          if(s_ty == 0){
            
            map_option['series'] = in_datas;
            choose_option['series'][0]['data'] = c_in_datas;

            choose_option['title']['text'] = "\n\n机场聚合";
            
            var airport = choose_option['title']['subtext'].split(" ")[0]
            choose_option['title']['subtext'] = airport+
                " 共 " + count_element(in_datas).toString()+ " 条航班";

            page_num = 1;
            temp = right_data_info;
            insert(1,right_data_info);
          }else if(s_ty == 1){
            //跨境off
            
            
            map_option['series'] = off_b_m_datas;
            choose_option['series'][0]['data'] = off_b_c_datas;
            var count  = count_flight(choose_option['series'][0]['data']);
            choose_option['title']['subtext'] = " 共 " + count+ " 条航班";

          }
          
          
          choose.clear();
          map.clear();
          choose.setOption(choose_option);
          map.setOption(map_option);
          echarts.connect([map,choose]);
      })

      $("#out").click(function(){

          $("#in").removeClass("action");
          $(this).addClass("action");
          if(s_ty == 0){
             
             
             map_option['series'] = out_datas;
             choose_option['series'][0]['data'] = c_out_datas;
             choose_option['title']['text'] = "\n\n机场聚合";
             var airport = choose_option['title']['subtext'].split(" ")[0]
             choose_option['title']['subtext'] = airport+
                " 共 " + count_element(out_datas).toString()+ " 条航班";

             temp = left_data_info;
             page_num = 1;
             insert(1,left_data_info);
          }else if(s_ty == 1){
              //on

              map_option['series'] = on_b_m_datas;
              choose_option['series'][0]['data'] =on_b_c_datas;
              var count  = count_flight(choose_option['series'][0]['data']);
              choose_option['title']['subtext'] = " 共 " + count+ " 条航班";
          }
         
          choose.clear();
          map.clear();
          choose.setOption(choose_option);
          map.setOption(map_option);
          echarts.connect([map,choose]);

      })
       

      //输入框提示
      $.getJSON('/api/airports/',function(names){
          $("#airport-input").typeahead({source:names,updater:name_updater});
          $("#o-input").typeahead({source:names,updater:name_updater});
          $("#d-input").typeahead({source:names,updater:name_updater});
      });
      function tip_airline_country(){
        var names = []
        for(k in airlinesName){
          if(airlinesName[k] != ""){
            names.push(airlinesName[k])
          }
        }
        $("#airline-input").typeahead({source:names});
        $("#country-input").typeahead({source:Object.keys(countryNames)})

      }
      tip_airline_country();
      
      //选中提示分割
      name_updater = function(item){
          
          return item.split(" - ")[1]
      }
       
      //类型切换
      var li_do = document.getElementsByName('type-li')
      for(var i=0;i<li_do.length;i++){
        
        li_do[i].onclick = function(){
          
          var li_text = '\n                        <a role=\"menuitem\" tabindex=\"-1\">{type}</a>\n                    ';
          var span_text = '聚合类型: {type}\n <span class=\"caret\"></span>\n ';
          var temp = this.textContent.replace(/(^\s*)|(\s*$)/g, "");
          var temp1 = $("#dropdownMenu1").text().split(":")[1].replace(/(^\s*)|(\s*$)/g, "");
          this.innerHTML = li_text.format({"type":temp1});
          $("#dropdownMenu1").html(span_text.format({"type":temp}));
          
          switch(temp){
            case "机场":
              $("#airport-input").attr("type","text");
              $("#airline-input").attr("type","hidden");
              
              $("#od-div").attr("style","display:none;");
              $("#country-input").attr("type","hidden");
              s_ty = 0;
              break;
            case "国家":
              
              $("#airport-input").attr("type","hidden");
              $("#airline-input").attr("type","hidden");
              $("#od-div").attr("style","display:none;");
              $("#country-input").attr("type","text");
              s_ty = 1;
              break;
            case "起降":
              $("#airport-input").attr("type","hidden");
              $("#airline-input").attr("type","hidden");
              $("#od-div").attr("style","display:block;");
              $("#country-input").attr("type","hidden");
              s_ty = 2;
              break;
            case "航司":
              $("#airport-input").attr("type","hidden");
              $("#airline-input").attr("type","text");
              $("#od-div").attr("style","display:none;");
              $("#country-input").attr("type","hidden");
              s_ty = 3;
              break;
          }
          

        }
      }

      //去除null值
      var remove_null = function(item){
        for(var i=0;i<item.length;i++){

            var t_k = Object.keys(item[i])[0];

            if(t_k == "null"){

              item.splice(i,1);
            }
        }

        return item
      }

      //输入框内容交换
      $("#yqf").click(function(){
          var value1 = document.getElementById("o-input").value;
          var value2 = document.getElementById("d-input").value;

          document.getElementById("o-input").value=value2;
          document.getElementById("d-input").value=value1;
      });
      //计算元素个数
      function count_element(items){
          var len = 0;

          for(var i=0;i<items.length;i++){
              
              len = len + items[i]["data"].length
          }

          return len
      }
      //字符串格式化
      String.prototype.format = function(args) {
          var result = this;
          if (arguments.length < 1) {
              return result;
          }
          var data = arguments;        
          if (arguments.length == 1 && typeof (args) == "object") {
              data = args;
          }
          for (var key in data) {
              var value = data[key];
              if (undefined != value) {
                  result = result.replace("{" + key + "}", value);
              }
          }
          return result;
      }

      //获取颜色
      function get_color(k){
        switch(k){
          case "准点":
            return "#5CACEE";
            
          case "取消":
            return "#C23531";
          case "延误":
            return "#DAA520";
    
          case "未上报":
            return "#525252";

        }
      }

      //合并地图数据
      function merge_map_datas(data_0,data_1){
        
        var name = [];
        for(var i=0;i<data_0.length;i++){
          name.push(data_0[i]["name"]);
        }

        for(var i=0;i<data_1.length;i++){

          if(name.indexOf(data_1[i]["name"]) != -1){
            
            for(var j=0;j<data_0.length;j++){

                if(data_0[j]["name"] == data_1[i]["name"]){

                  
                  data_0[j]["data"] = data_0[j]["data"].concat(data_1[i]["data"]);
                  break;
                }
            }

          }else{

            data_0.push(data_1[i]);
          }
        }

        return data_0;
      }


       //合并饼图数据
      function merge_pie_datas(data_0,data_1){

        var name = [];
        for(var i=0;i<data_0.length;i++){
          name.push(data_0[i]["name"]);
        }

        for(var i=0;i<data_1.length;i++){
          if(name.indexOf(data_1[i]["name"]) != -1){

            for(var j=0;j<data_0.length;j++){

                if(data_0[j]["name"] == data_1[i]["name"]){

                  data_0[j]["value"] = data_0[j]["value"]+data_1[i]["value"]
                  break;
                }
            }

          }else{

            data_0.push(data_1[i]);
          }
        }

        return data_0;
      }

      //根据饼图计算有多少航班
      function count_flight(pie_data){

        var count = 0;
        for(var i=0;i<pie_data.length;i++){
          count = count + pie_data[i]["value"];
        }
        return count;
      }
    </script>
  </body>
</html>